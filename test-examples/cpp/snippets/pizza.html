<div><span class="text-purple-300">#include</span> <span class="text-orange-300">&lt;atomic&gt;</span></div>
<div><span class="text-purple-300">#include</span> <span class="text-orange-300">&lt;csignal&gt;</span></div>
<div><span class="text-purple-300">#include</span> <span class="text-orange-300">&lt;print&gt;</span></div>
<div><span class="text-purple-300">#include</span> <span class="text-orange-300">&lt;thread&gt;</span></div>
<div><span class="text-purple-300">#include</span> <span class="text-orange-300">&lt;kth/node.hpp&gt;</span></div>
<div><span class="text-purple-300">#include</span> <span class="text-orange-300">&lt;kth/node/executor/executor.hpp&gt;</span></div>
<div>&nbsp;</div>
<div><span class="text-purple-300">using namespace</span> kth;</div>
<div>&nbsp;</div>
<div><span class="text-purple-300">constexpr</span> <span class="text-purple-300">uint64_t</span> <span class="text-cyan-300">pizza_block</span> = <span class="text-cyan-300">57043</span>; <span class="text-gray-400">// Bitcoin Pizza Day (May 22, 2010)</span></div>
<div>&nbsp;</div>
<div><span class="text-purple-300">std::atomic&lt;bool&gt;</span> keep_running{<span class="text-cyan-300">true</span>};</div>
<div><span class="text-purple-300">std::atomic&lt;bool&gt;</span> block_received{<span class="text-cyan-300">false</span>};</div>
<div>&nbsp;</div>
<div><span class="text-purple-300">void</span> <span class="text-yellow-300">handle_signal</span>(<span class="text-purple-300">int</span> sig) {</div>
<div>&nbsp;&nbsp;keep_running = <span class="text-cyan-300">false</span>;</div>
<div>&nbsp;&nbsp;<span class="text-purple-300">std</span>::<span class="text-yellow-300">println</span>(<span class="text-green-300">"\nInterrupted by signal"</span>);</div>
<div>}</div>
<div>&nbsp;</div>
<div><span class="text-purple-300">int</span> <span class="text-yellow-300">main</span>() {</div>
<div>&nbsp;&nbsp;<span class="text-purple-300">std</span>::<span class="text-yellow-300">signal</span>(SIGINT, handle_signal);</div>
<div>&nbsp;&nbsp;<span class="text-purple-300">std</span>::<span class="text-yellow-300">signal</span>(SIGTERM, handle_signal);</div>
<div>&nbsp;</div>
<div>&nbsp;&nbsp;<span class="text-purple-300">node::configuration</span> config{<span class="text-purple-300">domain::config::network::mainnet</span>};</div>
<div>&nbsp;&nbsp;<span class="text-purple-300">node::executor</span> exec{config, <span class="text-cyan-300">false</span>};</div>
<div>&nbsp;</div>
<div>&nbsp;&nbsp;<span class="text-purple-300">std</span>::<span class="text-yellow-300">println</span>(<span class="text-green-300">"Initializing and starting node..."</span>);</div>
<div>&nbsp;</div>
<div>&nbsp;&nbsp;<span class="text-purple-300">bool</span> started = <span class="text-cyan-300">false</span>;</div>
<div>&nbsp;&nbsp;exec.<span class="text-yellow-300">init_run</span>(<span class="text-green-300">""</span>, <span class="text-purple-300">node::start_modules::all</span>, [&amp;](<span class="text-purple-300">code</span> <span class="text-purple-300">const</span>&amp; ec) {</div>
<div>&nbsp;&nbsp;&nbsp;&nbsp;<span class="text-purple-300">if</span> (ec) {</div>
<div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="text-purple-300">std</span>::<span class="text-yellow-300">println</span>(<span class="text-green-300">"Error starting node: {}"</span>, ec.<span class="text-yellow-300">message</span>());</div>
<div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="text-purple-300">return</span>;</div>
<div>&nbsp;&nbsp;&nbsp;&nbsp;}</div>
<div>&nbsp;&nbsp;&nbsp;&nbsp;started = <span class="text-cyan-300">true</span>;</div>
<div>&nbsp;&nbsp;&nbsp;&nbsp;<span class="text-purple-300">std</span>::<span class="text-yellow-300">println</span>(<span class="text-green-300">"âœ“ Node running"</span>);</div>
<div>&nbsp;&nbsp;});</div>
<div>&nbsp;</div>
<div>&nbsp;&nbsp;<span class="text-purple-300">while</span> (!started &amp;&amp; keep_running) {</div>
<div>&nbsp;&nbsp;&nbsp;&nbsp;<span class="text-purple-300">std::this_thread</span>::<span class="text-yellow-300">sleep_for</span>(<span class="text-purple-300">std::chrono</span>::<span class="text-yellow-300">milliseconds</span>(<span class="text-cyan-300">100</span>));</div>
<div>&nbsp;&nbsp;}</div>
<div>&nbsp;</div>
<div>&nbsp;&nbsp;<span class="text-purple-300">if</span> (!started) <span class="text-purple-300">return</span> <span class="text-cyan-300">1</span>;</div>
<div>&nbsp;</div>
<div>&nbsp;&nbsp;<span class="text-purple-300">auto</span>&amp; chain = exec.<span class="text-yellow-300">node</span>().<span class="text-yellow-300">chain</span>();</div>
<div>&nbsp;</div>
<div>&nbsp;&nbsp;<span class="text-gray-400">// Wait for sync to pizza_block</span></div>
<div>&nbsp;&nbsp;<span class="text-purple-300">size_t</span> current_height = <span class="text-cyan-300">0</span>;</div>
<div>&nbsp;&nbsp;<span class="text-purple-300">while</span> (keep_running &amp;&amp; current_height &lt; <span class="text-cyan-300">pizza_block</span>) {</div>
<div>&nbsp;&nbsp;&nbsp;&nbsp;chain.<span class="text-yellow-300">fetch_last_height</span>([&amp;](<span class="text-purple-300">code</span> <span class="text-purple-300">const</span>&amp; ec, <span class="text-purple-300">size_t</span> h) {</div>
<div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="text-purple-300">if</span> (!ec) current_height = h;</div>
<div>&nbsp;&nbsp;&nbsp;&nbsp;});</div>
<div>&nbsp;&nbsp;&nbsp;&nbsp;<span class="text-purple-300">std</span>::<span class="text-yellow-300">print</span>(<span class="text-green-300">"\rðŸ”„ Syncing... {}/{}"</span>, current_height, <span class="text-cyan-300">pizza_block</span>);</div>
<div>&nbsp;&nbsp;&nbsp;&nbsp;<span class="text-purple-300">std::this_thread</span>::<span class="text-yellow-300">sleep_for</span>(<span class="text-purple-300">std::chrono</span>::<span class="text-yellow-300">seconds</span>(<span class="text-cyan-300">1</span>));</div>
<div>&nbsp;&nbsp;}</div>
<div>&nbsp;</div>
<div>&nbsp;&nbsp;<span class="text-purple-300">if</span> (!keep_running) {</div>
<div>&nbsp;&nbsp;&nbsp;&nbsp;exec.<span class="text-yellow-300">close</span>();</div>
<div>&nbsp;&nbsp;&nbsp;&nbsp;<span class="text-purple-300">return</span> <span class="text-cyan-300">0</span>;</div>
<div>&nbsp;&nbsp;}</div>
<div>&nbsp;</div>
<div>&nbsp;&nbsp;<span class="text-purple-300">std</span>::<span class="text-yellow-300">println</span>(<span class="text-green-300">"\nâœ“ Synced to block {}"</span>, <span class="text-cyan-300">pizza_block</span>);</div>
<div>&nbsp;&nbsp;<span class="text-purple-300">std</span>::<span class="text-yellow-300">println</span>(<span class="text-green-300">"Fetching block {} (Bitcoin Pizza Day)..."</span>, <span class="text-cyan-300">pizza_block</span>);</div>
<div>&nbsp;</div>
<div>&nbsp;&nbsp;chain.<span class="text-yellow-300">fetch_block</span>(<span class="text-cyan-300">pizza_block</span>, [&amp;](<span class="text-purple-300">code</span> <span class="text-purple-300">const</span>&amp; ec, <span class="text-purple-300">block_const_ptr</span> block, <span class="text-purple-300">size_t</span> h) {</div>
<div>&nbsp;&nbsp;&nbsp;&nbsp;<span class="text-purple-300">if</span> (ec) {</div>
<div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="text-purple-300">std</span>::<span class="text-yellow-300">println</span>(<span class="text-green-300">"Error fetching block: {}"</span>, ec.<span class="text-yellow-300">message</span>());</div>
<div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;block_received = <span class="text-cyan-300">true</span>;</div>
<div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="text-purple-300">return</span>;</div>
<div>&nbsp;&nbsp;&nbsp;&nbsp;}</div>
<div>&nbsp;</div>
<div>&nbsp;&nbsp;&nbsp;&nbsp;<span class="text-purple-300">auto</span> hash = block-&gt;<span class="text-yellow-300">hash</span>();</div>
<div>&nbsp;&nbsp;&nbsp;&nbsp;<span class="text-purple-300">std</span>::<span class="text-yellow-300">print</span>(<span class="text-green-300">"Block {}: "</span>, h);</div>
<div>&nbsp;&nbsp;&nbsp;&nbsp;<span class="text-purple-300">for</span> (<span class="text-purple-300">int</span> i = hash.<span class="text-yellow-300">size</span>() - <span class="text-cyan-300">1</span>; i &gt;= <span class="text-cyan-300">0</span>; --i) {</div>
<div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="text-purple-300">std</span>::<span class="text-yellow-300">print</span>(<span class="text-green-300">"{:02x}"</span>, (<span class="text-purple-300">int</span>)hash[i]);</div>
<div>&nbsp;&nbsp;&nbsp;&nbsp;}</div>
<div>&nbsp;&nbsp;&nbsp;&nbsp;<span class="text-purple-300">std</span>::<span class="text-yellow-300">println</span>(<span class="text-green-300">""</span>);</div>
<div>&nbsp;&nbsp;&nbsp;&nbsp;block_received = <span class="text-cyan-300">true</span>;</div>
<div>&nbsp;&nbsp;});</div>
<div>&nbsp;</div>
<div>&nbsp;&nbsp;<span class="text-gray-400">// Wait for block to be received or interrupted</span></div>
<div>&nbsp;&nbsp;<span class="text-purple-300">while</span> (keep_running &amp;&amp; !block_received) {</div>
<div>&nbsp;&nbsp;&nbsp;&nbsp;<span class="text-purple-300">std::this_thread</span>::<span class="text-yellow-300">sleep_for</span>(<span class="text-purple-300">std::chrono</span>::<span class="text-yellow-300">seconds</span>(<span class="text-cyan-300">1</span>));</div>
<div>&nbsp;&nbsp;}</div>
<div>&nbsp;</div>
<div>&nbsp;&nbsp;exec.<span class="text-yellow-300">close</span>();</div>
<div>&nbsp;&nbsp;<span class="text-purple-300">return</span> <span class="text-cyan-300">0</span>;</div>
<div>}</div>
